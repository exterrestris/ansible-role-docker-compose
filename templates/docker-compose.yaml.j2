version: '{{ docker_compose_schema_version }}'

services:
{% for container in _docker_compose_containers %}
  {{ container.service_name }}:
{%  if container.image is mapping %}
{%   if container.image.tag is defined %}
    image: {{ container.image.name }}:{{ container.image.tag }}
{%   else %}
    image: {{ container.image.name }}
{%   endif %}
{%  else %}
    image: {{ container.image }}
{%  endif %}
{%  if container.user is defined %}
{%   if container.user is mapping %}
    user: "{{ container.user.user }}{% if container.user.group is defined %}:{{ container.user.group }}{% endif %}"
{%   else %}
    user: "{{ container.user }}"
{%   endif %}
{%  endif %}
{%  if container.expose is defined %}
{%   if container.expose is string %}
    expose:
      - "{{ container.expose }}"
{%   elif container.expose | length > 0 %}
    expose:
{%    for port in container.expose %}
      - "{{ port }}"
{%    endfor %}
{%   endif %}
{%  endif %}
{%  if container.ports is defined %}
{%   if container.ports is string %}
    ports:
      - "{{ container.ports }}"
{%   elif container.ports | length > 0 %}
    ports:
{%    for port in container.ports %}
{%     if port is mapping %}
      - "{% if port.ip is defined %}{{ port.ip }}:{% endif %}{{ port.host | default(port.port) }}:{{ port.container | default(port.port) }}{% if port.protocol is defined %}/{{ port.protocol }}{% endif %}"
{%     else %}
      - "{{ port }}"
{%     endif %}
{%    endfor %}
{%   endif %}
{%  endif %}
{%  if container.volumes is defined %}
{%   if container.volumes is string %}
    volumes:
      - "{{ container.volumes }}"
{%   elif container.volumes | length > 0 %}
    volumes:
{%    for volume in container.volumes %}
{%     if volume is mapping %}
      - "{{ volume.source }}:{{ volume.target }}"
{%     else %}
      - "{{ volume }}"
{%     endif %}
{%    endfor %}
{%   endif %}
{%  endif %}
{%  if container.networks is defined %}
{%   if container.networks is string %}
    networks:
      - "{{ container.networks }}"
{%   elif container.networks | length > 0 %}
    networks:
{%    for network in container.networks %}
      - "{{ network }}"
{%    endfor %}
{%   endif %}
{%  elif container.network_mode is defined %}
    network_mode: {{ container.network_mode }}
{%  endif %}
{%  if container.environment is defined %}
{%   if container.environment is string %}
    environment:
      - "{{ container.environment }}"
{%   elif container.environment | length > 0 %}
    environment:
{%    for env in container.environment %}
{%     if env is mapping %}
      - "{{ env.name }}={{ env.value}}"
{%     else %}
      - "{{ env }}"
{%     endif %}
{%    endfor %}
{%   endif %}
{%  endif %}
{%  if container.restart is defined %}
    restart: {{ container.restart }}
{%  endif %}
{%  if container.labels is defined %}
{%   if container.labels is string %}
    labels:
      - "{{ container.labels }}"
{%   elif container.labels | length > 0 %}
    labels:
{%    for label in container.labels %}
{%     if label is mapping %}
      - "{{ label.name }}{% if label.value is defined %}={{ label.value }}{% endif %}"
{%     else %}
      - "{{ label }}"
{%     endif %}
{%    endfor %}
{%   endif %}
{%  endif %}
{% endfor %}

{% if _docker_compose_networks | length > 0 %}
networks:
{%  for network in _docker_compose_networks %}
  {{ network.name }}:
    external: {{ network.external | default('false') | string | lower }}
{%   if network.alias is defined %}
    name: {{ network.alias }}
{%   endif %}
{%   if network.driver is defined %}
    driver: {{ network.driver }}
{%   endif %}
{%   if network.driver_opts is defined %}
    driver_opts:
{%    for opt, value in network.driver_opts.items() %}
      {{ opt }}: {{ value }}
{%    endfor %}
{%   endif %}
{%  endfor %}
{% endif %}